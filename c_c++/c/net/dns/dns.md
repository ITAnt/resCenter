## DNS

DNS是基于UDP实现的

域名解析总体可分为两大步骤，第一个步骤是本机向本地域名服务器发出一个DNS请求报文，报文里携带需要查询的域名；第二个步骤是本地域名服务器向本机回应一个DNS响应报文，里面包含域名对应的IP地址。

### DNS报文

```
0                             15                              31
---------------------------------------------------------------		Header start
| Transaction ID(会话标识)     |   flags(标记) 			       |
---------------------------------------------------------------
| Questions(问题数)			| Answer RRs(回答资源记录数)       |
---------------------------------------------------------------
| Authonty RRs(授权资源记录数)  |  Additional RRs (附加资源记录数) |		Header end
---------------------------------------------------------------
|	Quenes （查询问题区域）										 |
---------------------------------------------------------------
|	Answers(回答区域)										    |
---------------------------------------------------------------
|					Authontative nameservers(授权区域)			|
---------------------------------------------------------------
|				Additional recoreds(附加区域)					|
---------------------------------------------------------------
```

#### 字段

1. TransactionID（会话标识2byte）是DNS报文的ID标识，对于请求报文和其对应的应答报文，这个字段是相同的，通过它可以区分DNS应答报文是哪个请求的响应

2. Flags

   QR（1bit）：查询/响应标志，0为查询，1为响应。

   opcode（4bit）：0表示标准查询，1表示反向查询，2表示服务器状态请求。

   AA（1bit）：表示授权回答。

   TC（1bit）：表示可截断的。

   RD（1bit）：表示期望递归。

   RA（1bit）：表示可用递归。

   *Z* ：保留值，暂时未使用。在所有的请求和应答报文中必须置为0。

   rcode（4bit）：

   rcode：应答码(Response code) ，这4个比特位在应答报文中设置，代表的含义如下：

   ​	0 没有错误。

   ​	1 报文格式错误(Format error) - 服务器不能理解请求的报文。

   ​	2 服务器失败(Server failure) - 因为服务器的原因导致没办法处理这个请求。

   ​	3 名字错误(Name Error) - 只有对授权域名解析服务器有意义，指出解析的域名不存在。

   ​	4 没有实现(Not Implemented) - 域名服务器不支持查询类型。

   ​	5 拒绝(Refused) - 服务器由于设置的策略拒绝给出应答。比如，服务器不希望对某些请求者给出应答，或者服务器不希望进行某些操作（比如区域传送zone transfer）

3. 数量字段（总共8字节）：Questions、Answer RRs、Authority RRs、Additional RRs 各自表示后面的四个区域的数目。Questions表示查询问题区域节的数量，Answers表示回答区域的数量，Authoritative namesversers表示授权区域的数量，Additional recoreds表示附加区域的数量

### 查询区域报文格式

```
0                             15                              31
---------------------------------------------------------------
|				Name （查询名，长度不固定）						|
---------------------------------------------------------------
|		Type(查询类型)			|			Class(查询类)		   |
---------------------------------------------------------------
```

#### 字段

1. 查询名：长度不固定，且不使用填充字节，一般该字段表示的就是需要查询的域名（如果是反向查询，则为IP，反向查询即由IP地址反查域名），一般的格式如下图所示。

   ```
   ---------------------------------------------
   | 6 | j | o | c | e | n | t | 2 | m | e | 0 |
   ---------------------------------------------
   ```

   6：表明其后面域名的长度 jocent 长度为 6

   2 ： me 的长度

   最后必须为 0

2. 查询类型：每个问题有一个查询类型。2个字节表示查询类型，取值可以为任何可用的类型值，以及通配码来表示所有的资源记录。

   | 类型 | 助记符 | 说明               |
   | ---- | ------ | ------------------ |
   | 1    | A      | 由域名获得IPv4地址 |
   | 2    | NS     | 查询域名服务器     |
   | 5    | CNAME  | 查询域名服务器     |
   | 6    | SOA    | 开始授权           |
   | 11   | WKS    | 熟知服务           |
   | 12   | PTR    | 把IP地址转换成域名 |
   | 13   | HINFO  | 主机信息           |
   | 15   | MX     | 邮件交换           |
   | 28   | AAAA   | 由域名获得IPv6地址 |
   | 252  | AXFR   | 传送整个区的请求   |
   | 255  | ANY    | 对所有记录的请求   |

3. 查询类：通常为 1，表明是 Internet 数据

### 回答区域的报文格式

```
0							  15							  31
----------------------------------------------------------------
|					Name(域名，2字节或长度不固定)					|
----------------------------------------------------------------
|		Type(查询类型)			|			Class(查询类)		   |
----------------------------------------------------------------
|					Time to live(生存时间)						 |
-----------------------------------------------------------------
|	Data length(资源数据长度)   |									|
-------------------------------
|					Data(资源数据，长度不固定)					 |
|																|
-----------------------------------------------------------------
```

**该区域有三个，但格式都是一样的。这三个区域分别是：回答区域，授权区域和附加区域。**

#### 字段

1. **域名**（2字节或不定长）：它的格式和查询区域的查询名字字段是一样的。有一点不同就是，当报文中域名重复出现的时候，该字段使用2个字节的偏移指针来表示。比如，在资源记录中，域名通常是查询问题部分的域名的重复，因此用2字节的指针来表示，具体格式是最前面的两个高位是 11，用于识别指针。其余的14位从DNS报文的开始处计数（从0开始），指出该报文中的相应字节数。
2. 查询类型：表明资源纪录的类型。
3. 查询类：对于Internet信息，总是IN（1）。
4. 生存时间（TTL）：以秒为单位，表示的是资源记录的生命周期，一般用于当地址解析程序取出资源记录后决定保存及使用缓存数据的时间，它同时也可以表明该资源记录的稳定程度，极为稳定的信息会被分配一个很大的值。
5. 资源数据：该字段是一个可变长字段，表示按照查询段的要求返回的相关资源记录的数据。可以是Address（表明查询报文想要的回应是一个IP地址）或者CNAME（表明查询报文想要的回应是一个规范主机名）等。



### 使用

- 组装 DNS 报文结构
- 建立 socket
- 发送报文
- 接收响应报文并解析报文

### 示例

见 dns_test.c