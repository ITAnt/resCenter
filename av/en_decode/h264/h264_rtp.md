H264打包RTP



TCP建立之后，传输数据的大小不受限制，双方可按照一定的格式传输大量的数据，而 udp 最大为 64k。

64 k = 65536 = 2 ^16



H.264 Payload 格式定义了三种不同的基本的负载(Payload)结构. 接收端可能通过 RTP Payload  的第一个字节来识别它们. 这一个字节类似 NALU 头的格式, 而这个头结构的 NAL 单元类型字段  则指出了代表的是哪一种结构,

 这个字节的结构如下, 可以看出它和 H.264 的 NALU 头结构是一样的.

```
       +---------------+
      |0|1|2|3|4|5|6|7|
      +-+-+-+-+-+-+-+-+
      |F|NRI|  Type   |
      +---------------+
```

字段 Type: 这个 是RTP payload 中 NAL 单元的类型. 这个字段和 H.264 中类型字段的区别是, 当 type  的值为 24 ~ 31 表示这是一个特别格式的 NAL 单元, 而 H.264 中, 只取 1~23 是有效的值.

可能的结构类型分别有：

1. 单一NAL 单元模式

   即一个 RTP 包仅由一个完整的 NALU 组成. 这种情况下 RTP NAL 头类型字段和原始的 H.264的  NALU 头类型字段是一样的

2. 组合封包模式

   即可能是由多个 NAL 单元组成一个 RTP 包. 分别有4种组合方式: STAP-A, STAP-B, MTAP16, MTAP24.  那么这里的类型值分别是 24, 25, 26 以及 27

3. 分片封包模式

   用于把一个 NALU 单元封装成多个 RTP 包. 存在两种类型 FU-A 和 FU-B. 类型值分别是 28 和 29



H264关于RTP协议的实现：

​	Qos反馈控制根据 RR 报文反馈信息动态的对发送速率进行调整

​	RTCP模块根据 SR 报文统计信息，产生并发送 RR 包



只有拆分后才会避免 IP 层在传输时出现分片

​	1500 - 20 - （8+12） = 1460 字节

20： IP 头

8：udp 头

12：RTP 头

产生大于 MTU 的包。在IP层其将会被分割成几个小于 MTU 尺寸的包，这样将会无法检测数据是否丢失，因为IP  和 UDP 协议都没有提供分组到达的检测。



UDP数据分组小于 64k 字节。

H.264 媒体流的 RTP 负载格式，主要有三种：

1. 单元 NAL 单元分组 （单个 NALU 传递）

2. 聚合分组 （多个NALU  聚合）

   1. 单一时间聚合分组（STAP）
   2. 多时间聚合分组（MATP）

3. 片分组

   ​	共有两个类型  FU-A 和 FU-B，分别为 28 和 29

可在两个层次进行分割：

1. 视频编码层 VCL 的分割

   调整编码 Slice 的大小

2. 网络提取层NAL 上的分割



一个NAL单元采用分割分组后，每个 RTP 分组序列号依次递增 1 ，RTP时间戳相同且唯一。

NAL 单元的分割是 RTP 打包机制的一个主要环节，特点：

1. 
2. 层
3. 的
4. 分
5. 





SDP

RTCP反馈特定信息编码到本地 SDP 中，表明本地端点有能力并且愿意接收本地 SDP 中描述的 RTCP 反馈数据包。

从SDP媒体解码 RTCP FB 特定信息。

a=fmtp:99 profile-level-id = 420A01E;packetization-mode =1;sprop-parameter-ets=Z01ACpZTBYml,aMIjiA==

420A01E：SPS 的开头几个字节

packetization-mode=1：要求每个 RTP 中只有一个NAL 单元，或者一个 FU

sprop-parameter-ets = Z01ACpZTBYml,aMIjiA== ：SPS 和 PPS 的Base64 转码，不用在码流中再传输 SPS/PPS