### 流量整形技术

超出网络承载能力的数据包，可能会被网卡/路由器/交换机给丢掉，即我们常说的丢包（loss）。对于网络传输，丢包带来的成本是很高的。因此，需要从*根本上尽可能地减少 “丢包” 的产生，简单来说，就是控制单位时间内送入网络传输的数据量，尽量平滑且不要超过网络带宽承载能力。*

#### 控制对象

设置和修改采集的配置（如：分辨率、帧率）、编码器的配置（如：GOP 间隔、码率）等，是可以减少实时产生的总数据量的，但是数据的产生并不是 “平滑” 的，特别是视频流/屏幕流，画面的突变，会带来数据量的突变，因此，送入到 “发送模块” 的数据量，也并不会总是 “平滑” 的。

#### 流量整形

##### 漏桶算法

增加 “缓冲”，让输入的数据先进入 “缓冲区” ，然后用恒定的 “速率” 从缓冲区取数据输出。这种方法称之为 “漏桶算法”。

设置一个目标的输出码率（比如：3Mbps），固定的时间间隔（比如：10ms），读取 packet buffer（漏桶）中固定数量的 packet（如：3Mbit * 10ms / 1000 = 0.03Mbit）进行网络发送。

**缺点：**

漏桶算法无法充分用满网络资源来降低传输延时。

##### 解决方案

1. 先慢启动，然后将漏桶的目标码率持续上探，直到出现网络恶化（如：丢包增多）后再降下来，如此反复，维持一个动态平衡，使得漏桶算法的目标码率持续无限逼近网络的承载能力
2. 改进漏桶算法，允许其在执行过程中，偶尔出现一些超过预设平均值的突发传输能力，用于应对业务上的流量突发，即：令牌桶算法

##### 令牌桶算法

令牌（固定速率）+令牌桶（处理突变的浮动速率）。当然，为了防止突破网络承载能力导致丢包，“令牌桶” 的最大 “令牌数量” 也相应做了一些限制。

